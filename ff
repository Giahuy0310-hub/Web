<?php
require_once('db_connection.php'); // Đảm bảo đường dẫn tới tệp là chính xác

// Trích xuất tham số product_id từ URL
$product_id = isset($_GET['id']) ? $_GET['id'] : null;
$tenmau = isset($_GET['tenmau']) ? $_GET['tenmau'] : null;

// Kiểm tra xem product_id có giá trị hợp lệ không
if (!is_numeric($product_id) || $product_id <= 0) {
    // Xử lý khi không có hoặc có giá trị product_id không hợp lệ
    echo "Không có sản phẩm được chọn hoặc giá trị không hợp lệ.";
    exit; // Kết thúc kịch bản để không tiếp tục xử lý
}

// Truy vấn SQL để lấy color_id từ tên màu
$sqlColorId = "SELECT id_color FROM color WHERE tenmau = ?";
$stmt = $conn->prepare($sqlColorId);
$stmt->bind_param('s', $tenmau);
$stmt->execute();
$resultColorId = $stmt->get_result();

if ($resultColorId->num_rows > 0) {
    $row = $resultColorId->fetch_assoc();
    $color_id = $row['id_color'];
} else {
    // Xử lý khi không tìm thấy color_id cho tên màu này
    echo "Không tìm thấy thông tin về màu sắc này.";
    exit;
}

// Truy vấn chính để lấy thông tin sản phẩm từ bảng product_color
$sqlProductDetail = "SELECT pc.*, p.ten_san_pham, p.link_hinh_anh, p.gia, p.rating, p.so_danh_gia 
                    FROM product_color pc
                    JOIN products p ON pc.product_id = p.ID
                    WHERE pc.product_id = ? AND pc.color_id = ?";
$stmt = $conn->prepare($sqlProductDetail);
$stmt->bind_param('ii', $product_id, $color_id);
$stmt->execute();
$resultProductDetail = $stmt->get_result();

// Kiểm tra xem sản phẩm có tồn tại không
if ($resultProductDetail->num_rows > 0) {
    $productDetail = $resultProductDetail->fetch_assoc();
} else {
    // Xử lý khi không tìm thấy thông tin sản phẩm
    echo "Sản phẩm không tồn tại hoặc không có sẵn trong màu sắc này.";
    exit;
}

// Kiểm tra xem product_id và rating có tồn tại và hợp lệ không
if (isset($_POST['rating'])) {
    $rating = intval($_POST['rating']);
    
    if ($rating >= 1 && $rating <= 5) { // Đánh giá phải nằm trong khoảng từ 1 đến 5
        // Cập nhật đánh giá sản phẩm trong cơ sở dữ liệu (sử dụng truy vấn chuẩn bị và tham số hóa)
        $sqlUpdateRating = "UPDATE products SET rating = ? WHERE ID = ?";
        $stmt = $conn->prepare($sqlUpdateRating);
        $stmt->bind_param('ii', $rating, $product_id);

        if ($stmt->execute()) {
            // Trả về phản hồi thành công
            echo "Cập nhật đánh giá thành công.";
        } else {
            // Xử lý lỗi khi cập nhật đánh giá
            echo "Lỗi: " . $stmt->error;
        }
    } else {
        // Xử lý lỗi khi đánh giá không hợp lệ
        echo "Đánh giá không hợp lệ. Vui lòng chọn đánh giá từ 1 đến 5.";
    }
}

// Truy vấn cơ sở dữ liệu để lấy danh sách các danh mục sản phẩm từ bảng "categories"
$sqlCategories = "SELECT ID_DM, TenDanhMuc FROM categories";
$stmt = $conn->prepare($sqlCategories);
$stmt->execute();
$resultCategories = $stmt->get_result();

$categoryList = [];
if ($resultCategories->num_rows > 0) {
    while ($row = $resultCategories->fetch_assoc()) {
        $categoryList[] = [
            'ID_DM' => $row['ID_DM'],
            'TenDanhMuc' => $row['TenDanhMuc'],
        ];
    }
}

// Xác định danh mục sản phẩm và danh mục con được chọn (nếu có) từ tham số truy vấn
$selectedCategory = isset($_GET['ID_DM']) ? $_GET['ID_DM'] : null;
$selectedSubcategory = isset($_GET['loaisanpham']) ? $_GET['loaisanpham'] : null;

// Truy vấn cơ sở dữ liệu để lấy danh sách sản phẩm dựa trên danh mục sản phẩm và danh mục con được chọn
$sqlProducts = "SELECT * FROM products WHERE 1=1"; // Sử dụng "WHERE 1=1" để dễ dàng thêm điều kiện

if (!empty($selectedCategory)) {
    $sqlProducts .= " AND ID_DM = ?";
}

if (!empty($selectedSubcategory)) {
    $sqlProducts .= " AND loaisanpham = ?";
}

$stmt = $conn->prepare($sqlProducts);

if (!empty($selectedCategory) && !empty($selectedSubcategory)) {
    $stmt->bind_param('is', $selectedCategory, $selectedSubcategory);
} elseif (!empty($selectedCategory)) {
    $stmt->bind_param('i', $selectedCategory);
} elseif (!empty($selectedSubcategory)) {
    $stmt->bind_param('s', $selectedSubcategory);
}

$stmt->execute();
$resultProducts = $stmt->get_result();

$productList = [];
if ($resultProducts->num_rows > 0) {
    while ($row = $resultProducts->fetch_assoc()) {
        $productList[] = [
            'ID' => $row['ID'],
            'ID_DM' => $row['ID_DM'],
            'TenSanPham' => $row['ten_san_pham'],
            'LinkHinhAnh' => $row['link_hinh_anh'],
            'Gia' => $row['gia'],
        ];
    }
}

// Truy vấn danh mục con dựa trên cột "loaisanpham" trong bảng "products" và giá trị ID_DM
$subcategories = [];
foreach ($categoryList as $category) {
    $categoryID = $category['ID_DM'];
    $sqlSubcategories = "SELECT DISTINCT loaisanpham FROM products WHERE ID_DM = ?";
    $stmt = $conn->prepare($sqlSubcategories);
    $stmt->bind_param('i', $categoryID);
    $stmt->execute();
    $resultSubcategories = $stmt->get_result();

    if ($resultSubcategories->num_rows > 0) {
        $subcategoryList = [];
        while ($row = $resultSubcategories->fetch_assoc()) {
            $subcategoryList[] = $row['loaisanpham'];
        }
        $subcategories[$categoryID] = $subcategoryList;
    }
}

$conn->close();
?>

<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="css/products_detail.css">
    <link rel="stylesheet" href="css/menu.css">

    <link rel="icon" href="3.jpg" type="image/x-icon">
    <script src="js/product_detail.js"></script>
</head>
<body>
    <div class="container">
        <header>
        </header>

        <div class="menu">
            <div class="dropdown">
            </div>
            <?php
            // Tạo menu danh mục sản phẩm động
            foreach ($categoryList as $category) {
                $categoryID = $category['ID_DM'];
                $categoryName = $category['TenDanhMuc'];
                $isActive = $categoryID == $selectedCategory ? 'active' : '';
                echo "<div class='dropdown'>";
                echo "<a class='category-button $isActive' href='products.php?ID_DM=$categoryID'>$categoryName</a>";
                
                // Hiển thị danh mục con nếu có
                if (isset($subcategories[$categoryID])) {
                    echo "<div class='dropdown-menu'>";
                    foreach ($subcategories[$categoryID] as $subcategory) {
                        $subcategoryLink = "products.php?ID_DM=$categoryID&loaisanpham=" . urlencode($subcategory);
                        echo "<a href='$subcategoryLink'>$subcategory</a>";
                    }
                    echo "</div>";
                }
                
                echo "</div>";
            }
            ?>
        </div>
        <div class="product-detail-container">
            <?php
            // Kiểm tra nếu trang được tải lại
            if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['reload'])) {
                echo '<script>modalVisible = false;</script>';
            }

            if (isset($productDetail)) {
                echo "<div class='additional-data'>";
                $imgFields = ['img1', 'img2', 'img3', 'img4'];

                foreach ($imgFields as $index => $imgField) {
                    $imageURL = $productDetail[$imgField];
                    $altText = "Hình ảnh " . ($index + 1);
                    echo "<img class='small-image' src='$imageURL' alt='$altText' onclick='showLargeImage(\"$imageURL\")'>";
                }

                echo "</div>";
                echo "<div class='product-detail-image'>";
                echo "<img id='largeImage' src='" . $productDetail['link_hinh_anh'] . "' alt='" . $productDetail['ten_san_pham'] . "' onclick='openModal()'>";
                echo "</div>";
                echo "<div class='product-detail-info'>";
                echo "<h2>" . $productDetail['ten_san_pham'] . "</h2>";
                echo "<div class='product-detail-price'>Giá: " . $productDetail['gia'] . "</div>";
                
                // Kiểm tra xem khóa "rating" có tồn tại trong mảng $productDetail không
                if (array_key_exists('rating', $productDetail)) {
                    echo "<div class='product-detail-rating'>";
                    echo "<h3>Đánh giá sản phẩm</h3>";
                    echo "<div class='star-rating'>";

                    $rating = $productDetail['rating'];

                    // Tính toán số sao nguyên và phần thập phân
                    $wholeStars = floor($rating);
                    $decimalPart = $rating - $wholeStars;

                    // Hiển thị các sao đánh giá
                    for ($i = 1; $i <= 5; $i++) {
                        $selectedClass = ($i <= $wholeStars) ? 'selected' : ''; // Đánh dấu sao đã được chọn

                        // Sử dụng biểu tượng Unicode của ngôi sao và ngôi sao trống (nếu cần)
                        echo "<span class='star $selectedClass' onclick='rateProduct($i)'>";
                        
                        if ($i <= $wholeStars) {
                            echo "&#9733;"; // Hiển thị sao đầy đủ
                        } elseif ($i - 1 < $wholeStars && $i - 0.5 > $wholeStars) {
                            echo "&#9734;&#188;"; // Hiển thị nửa phần thứ 5 của sao
                        } else {
                            echo "&#9734;"; // Hiển thị sao trống
                        }
                        
                        echo "</span>";
                    }
                    echo "</div>";
                    
                    // Kiểm tra xem khóa "so_danh_gia" có tồn tại trong mảng $productDetail không
                    if (array_key_exists('so_danh_gia', $productDetail)) {
                        echo "<p>" . number_format($productDetail['rating'], 1) . " / 5.0 (Đánh giá từ " . $productDetail['so_danh_gia'] . " người dùng)</p>";
                    }
                    
                    echo "<button class='write-review-button' onclick='showReviewForm()'>Viết đánh giá</button>";
                    echo "</div>";
                }
                echo "</div>";
            }
            ?>
        </div>
        <footer>
            <p>&copy; 2023 Website Bán Hàng</p>
        </footer>
    </div>

    <!-- Modal cho ảnh lớn -->
    <div id="imageModal" class="modal">
        <span class="closeModal" onclick="closeModal()">&times;</span>
        <img id="modalImage" src="" alt="Ảnh lớn" class="modal-content">
    </div>

    <!-- Thêm một form để xử lý load lại trang -->
    <!-- <form method="post">
        <input type="hidden" name="reload" value="1">
        <input type="submit" value="Reload">
    </form> -->
</body>
</html>
